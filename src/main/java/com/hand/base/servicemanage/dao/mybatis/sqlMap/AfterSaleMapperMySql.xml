<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hand.base.servicemanage.dao.mybatis.mapper.AfterSaleMapper">
	<resultMap type="com.hand.base.servicemanage.model.AfterSale" id="afterSale"></resultMap>
	
	<sql id="queryTableSql">
		SELECT
			t1.ROW_ID id,
			date_format(t1.created,'%Y-%m-%d %H:%i:%S') created,
			t1.CREATED_BY createdBy,
			date_format(t1.LAST_UPD,'%Y-%m-%d %H:%i:%s') lastUpdated,
			t1.LAST_UPD_BY lastUpdatedBy,
			t1.CORP_ID corpid,
			t1.aftermarket_type aftermarketType,/*售后类型*/
			t1.order_Id orderId,/*订单ID*/
			t2.order_num orderNumber,/*订单编号*/
			t2.O2O_PAY_TYPE payType,/*支付方式*/
			t1.phonenumber phonenumber,/*联系电话*/
			t3.name fstName, /*消费者*/
			T2.ACCNT_ID customerId, /*消费者Id*/
			t1.after_sales_amount afterSalesAmount,/*售后金额*/
			t1.reason reason,/*原因*/
			t1.instruction_manual instructionManual,/*备注说明*/
			t1.document_information documentInformation,/*凭证信息*/
			t1.processing_status processingStatus,/*处理状态*/
			t4.STATUS refundResult,/*退款结果*/
			t1.notes notes,/*审批意见*/
			t1.logistics_company  as logisticsCompany,   /*物流公司*/
			t1.logistics_odd_number as logisticsOddNumber, /*物流单号*/
			t1.address as address, /*退货地址*/
			t1.contact  as contact,   /*退货验收人*/
			t1.contPhone as contPhone /*退货收货人联系电话*/
	</sql>
	        
	<sql id="fromTableSql">
			FROM
				lnk_aftermarket t1
			LEFT JOIN (s_order_x t2
				LEFT JOIN lnk_accnt T3 ON T2.ACCNT_ID = T3.ROW_ID
			) ON t2.row_id = t1.order_Id
			LEFT JOIN CX_O_PAY_INFO T4 ON t1.order_Id = T4.ORDER_ID and t4.T_ATTR_01 = 'Refund'
			
	</sql>
	
	<sql id="whereTableSql">
		WHERE 1 = 1
		<if test="usersystemRole!= 'super_administrator' ">
			and t1.corp_id = #{usercorpid}
		</if>
		<if test="id != null and id != ''">
			and t1.ROW_ID LIKE CONCAT('%',#{id},'%')
		</if>
		<if test="aftermarketType != null and aftermarketType != ''">
			and t1.aftermarket_type = #{aftermarketType}
		</if>
		<if test="orderNumber != null and orderNumber != ''">
			and t2.order_num LIKE CONCAT('%',#{orderNumber},'%')
		</if>
		<if test="fstName != null and fstName != ''">
			and t3.name LIKE CONCAT('%',#{fstName},'%')
		</if>
		<if test="phonenumber != null and phonenumber != ''">
			and t1.phonenumber LIKE CONCAT('%',#{phonenumber},'%')
		</if>
		<if test="processingStatus != null and processingStatus != ''">
			and t1.processing_status = #{processingStatus}
		</if>
		<if test="refundResult != null and refundResult != ''">
			and t4.STATUS LIKE CONCAT('%',#{refundResult},'%')
		</if>
	</sql>
	
	<select id="queryByExamplePage" resultMap="afterSale" parameterType="com.hand.base.servicemanage.model.AfterSale">
		<include refid="queryTableSql" />
		<include refid="fromTableSql" />
		<include refid="whereTableSql" />
		order by t1.CREATED desc
	</select>
	
	<select id="brandQueryByExamplePage" resultMap="afterSale" parameterType="com.hand.base.servicemanage.model.AfterSale">
		<include refid="queryTableSql" />
		<include refid="fromTableSql" />
		<include refid="whereTableSql" />
		order by t1.CREATED desc
	</select>
	
	
	<insert id="insert" parameterType="com.hand.base.servicemanage.model.AfterSale">
		INSERT INTO lnk_aftermarket(
			ROW_ID,
			aftermarket_type,
			order_Id,
			phonenumber,
			after_sales_amount,
			reason,
			instruction_manual,
			document_information,
			processing_status,
			refund_result,
			address,
			contact,
			contPhone
		)
		VALUES(
			#{id},
			#{aftermarketType},
			#{orderId},
			#{phonenumber},
			#{afterSalesAmount},
			#{reason},
			#{instructionManual},
			#{documentInformation},
			#{processingStatus},
			#{refundResult},
			#{address},
			#{contact},
			#{contPhone}
		)
	</insert>
	
	<insert id="brandInsert" parameterType="com.hand.base.servicemanage.model.AfterSale">
		INSERT INTO lnk_aftermarket(
			ROW_ID,
			aftermarket_type,
			order_Id,
			phonenumber,
			after_sales_amount,
			reason,
			instruction_manual,
			document_information,
			processing_status,
			refund_result,
			address,
			contact,
			contPhone
		)
		VALUES(
			#{id},
			#{aftermarketType},
			#{orderId},
			#{phonenumber},
			#{afterSalesAmount},
			#{reason},
			#{instructionManual},
			#{documentInformation},
			#{processingStatus},
			#{refundResult},
			#{address},
			#{contact},
			#{contPhone}
		)
	</insert>
	
	
	<update id="update" parameterType="com.hand.base.servicemanage.model.AfterSale">
		update lnk_aftermarket t
		   set t.row_id = #{id}
		   	   <if test="aftermarketType != null and aftermarketType != ''">
		   	   ,t.aftermarket_type = #{aftermarketType}
		   	   </if>
		   	   <if test="orderId != null and orderId != ''">
		       ,t.order_Id = #{orderId}
		       </if>
		   	   <if test="phonenumber != null and phonenumber != ''">
		       ,t.phonenumber=#{phonenumber}
		       </if>
		   	   <if test="afterSalesAmount != null and afterSalesAmount != ''">
		       ,t.after_sales_amount = #{afterSalesAmount}
		       </if>
		   	   <if test="reason != null and reason != ''">
		       ,t.reason = #{reason}
		       </if>
		   	   <if test="instructionManual != null and instructionManual != ''">
		       ,t.instruction_manual=#{instructionManual}
		       </if>
		   	   <if test="documentInformation != null and documentInformation != ''">
		       ,t.document_information = #{documentInformation}
		       </if>
		   	   <if test="processingStatus != null and processingStatus != ''">
		       ,t.processing_status = #{processingStatus}
		       </if>
		   	   <if test="refundResult != null and refundResult != ''">
		       ,t.refund_result=#{refundResult}
		       </if>
		       <if test=" confirmationTime != null">
				,CONFIRMATION_TIME  =#{confirmationTime}      /*客服确认时间*/
				</if>
				<if test=" approvalTime != null">
				,APPROVAL_TIME  =#{approvalTime}      /*客服受理时间*/
				</if>
		   	   <if test="notes != null and notes != ''">
		       ,t.notes=#{notes}
		       </if>
		   	   <if test="address != null and address != ''">
		       ,t.address=#{address}
		       </if>
		   	   <if test="contact != null and contact != ''">
		       ,t.contact=#{contact}
		       </if>
		   	   <if test="contPhone != null and contPhone != ''">
		       ,t.contPhone=#{contPhone}
		       </if>
		 where t.row_id = #{id}
	</update>
	
	<update id="brandUpdate" parameterType="com.hand.base.servicemanage.model.AfterSale">
		update lnk_aftermarket t
		   set t.row_id = #{id}
		   	   <if test="aftermarketType != null and aftermarketType != ''">
		   	   ,t.aftermarket_type = #{aftermarketType}
		   	   </if>
		   	   <if test="orderId != null and orderId != ''">
		       ,t.order_Id = #{orderId}
		       </if>
		   	   <if test="phonenumber != null and phonenumber != ''">
		       ,t.phonenumber=#{phonenumber}
		       </if>
		   	   <if test="afterSalesAmount != null and afterSalesAmount != ''">
		       ,t.after_sales_amount = #{afterSalesAmount}
		       </if>
		   	   <if test="reason != null and reason != ''">
		       ,t.reason = #{reason}
		       </if>
		   	   <if test="instructionManual != null and instructionManual != ''">
		       ,t.instruction_manual=#{instructionManual}
		       </if>
		   	   <if test="documentInformation != null and documentInformation != ''">
		       ,t.document_information = #{documentInformation}
		       </if>
		   	   <if test="processingStatus != null and processingStatus != ''">
		       ,t.processing_status = #{processingStatus}
		       </if>
		   	   <if test="refundResult != null and refundResult != ''">
		       ,t.refund_result=#{refundResult}
		       </if>
		       <if test=" confirmationTime != null">
				,CONFIRMATION_TIME  =#{confirmationTime}      /*客服确认时间*/
				</if>
				<if test=" approvalTime != null">
				,APPROVAL_TIME  =#{approvalTime}      /*客服受理时间*/
				</if>
		   	   <if test="notes != null and notes != ''">
		       ,t.notes=#{notes}
		       </if>
		   	   <if test="address != null and address != ''">
		       ,t.address=#{address}
		       </if>
		   	   <if test="contact != null and contact != ''">
		       ,t.contact=#{contact}
		       </if>
		   	   <if test="contPhone != null and contPhone != ''">
		       ,t.contPhone=#{contPhone}
		       </if>
		 where t.row_id = #{id}
	</update>
		
	<delete id="deleteById" parameterType="com.hand.base.servicemanage.model.AfterSale">
		DELETE FROM lnk_aftermarket WHERE ROW_ID = #{id}
	</delete>
	
	<select id="queryById" resultMap="afterSale" parameterType="com.hand.base.servicemanage.model.AfterSale">
		<include refid="queryTableSql" />
		<include refid="fromTableSql" />
		<include refid="whereTableSql" />
		AND t1.ROW_ID = #{id}
	</select>
	
	<select id="brandQueryById" resultMap="afterSale" parameterType="com.hand.base.servicemanage.model.AfterSale">
		<include refid="queryTableSql" />
		<include refid="fromTableSql" />
		<include refid="whereTableSql" />
		AND t1.ROW_ID = #{id}
	</select>
	
	<select id="queryApplyPicAll" resultMap="afterSale" parameterType="com.hand.base.servicemanage.model.AfterSale">
		SELECT
			t1.ROW_ID id,
			date_format(t1.created,'%Y-%m-%d %H:%i:%S') created,
			t1.CREATED_BY createdBy,
			date_format(t1.LAST_UPD,'%Y-%m-%d %H:%i:%s') lastUpdated,
			t1.LAST_UPD_BY lastUpdatedBy,
			t1.CORP_ID corpid,
			t3.path path
		FROM
			lnk_inter_aftersale_apply t1
		LEFT JOIN lnk_aftermarket t2 ON t2.row_id = t1.afterSale_id
		LEFT JOIN cx_o_img t3 ON t3.row_id = t1.pic_id
		WHERE
			t1.afterSale_id =  #{id}
	</select>
	
	<select id="queryReturnPicAll" resultMap="afterSale" parameterType="com.hand.base.servicemanage.model.AfterSale">
		SELECT
			t1.ROW_ID id,
			date_format(t1.created,'%Y-%m-%d %H:%i:%S') created,
			t1.CREATED_BY createdBy,
			date_format(t1.LAST_UPD,'%Y-%m-%d %H:%i:%s') lastUpdated,
			t1.LAST_UPD_BY lastUpdatedBy,
			t1.CORP_ID corpid,
			t3.path path
		FROM
			lnk_inter_afterSale_return t1
		LEFT JOIN lnk_aftermarket t2 ON t2.row_id = t1.afterSale_id
		LEFT JOIN cx_o_img t3 ON t3.row_id = t1.pic_id
		WHERE
			t1.afterSale_id =  #{id}
	</select>
</mapper>