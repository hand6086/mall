<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hand.base.workbench.dao.mybatis.mapper.CampaignMapper">
	<resultMap type="com.hand.base.workbench.model.Campaign" id="campaign"></resultMap>
	
	<sql id="queryAllSql">
	select
	T.ROW_ID as id,
	date_format(T.CREATED,'%Y-%m-%d %H:%i:%S') as created,
	T.CREATED_BY as createdBy,
	date_format(T.LAST_UPD, '%Y-%m-%d %H:%i:%S') as lastUpdated,
	T.LAST_UPD_BY as lastUpdatedBy,
	T.corp_id      as corpId,
	t.Name name,
	t.CODE code,
	t.STATUS status,
	t.T_ATTR_01 shareType,
	t.T_ATTR_02 shareTheme,
	t.T_ATTR_05 url,
	t.T_ATTR_04 shareNotes,
	t.TYPE type,
	t1.NAME cityName,
	t.T_ATTR_06 cityId,
	t4.row_id orgId,
	t.T_ATTR_03 charePicId,
	t2.path shareUrl,
	t.source source,
	t.classify_id classifyId,
	t3.name classifyName
	</sql>

	<sql id="fromSql">
		 from CX_O_CAMPAIGN t
		 LEFT JOIN (CX_O_AREA t1  LEFT JOIN lnk_org_ext T4 ON T4.ROW_ID = T1.T_ATTR_05) 
		 on t1.ROW_ID=t.T_ATTR_06
		 left join cx_o_img t2 on t2.row_id = t.T_ATTR_03
		 left join lnk_brand_classify t3 on t3.row_id = t.classify_id

  	</sql>
  	
  	<sql id="whereAllSql">
  		where 1 = 1
  		<if test="type=='List Type'">
  			and (t.type='纵向列表承接页' or t.type='List Type')
  		</if>
  		<if test="type=='Stack Type'">
  			and (t.type='品字形承接页' or t.type='Stack Type')
  		</if>
  		<if test="type=='Single Pic Type'">
  			and (t.type='单张图片承接页' or t.type='Single Pic Type')
  		</if>
  		<if test="type=='Coupon Type'">
  			and (t.type='优惠券领取承接页' or t.type='Coupon Type')
  		</if>
  		<if test="cityId != '' and cityId != null">
  			and t.T_ATTR_06 = #{cityId}
  			and t.STATUS = 'Active'
  		</if>
  	</sql>
  	
  	<select id="queryByExamplePage" parameterType="com.hand.base.workbench.model.Campaign" resultMap="campaign">
  		<include refid="queryAllSql"/>
		<include refid="fromSql"/>
		<include refid="whereAllSql"/>
		<if test=" source == null or source == '' ">
			and t.source = 'fast shopping'
		</if>
		<if test=" source != null and source != '' ">
			and t.source = #{source}
		</if>
		order by t.CREATED desc
  	</select>
  	
  	<select id="brandQueryByExamplePage" parameterType="com.hand.base.workbench.model.Campaign" resultMap="campaign">
  		<include refid="queryAllSql"/>
		<include refid="fromSql"/>
		<include refid="whereAllSql"/>
		and t.source = 'brand'
		order by t.CREATED desc
  	</select>
  	
	<select id="queryById" resultType="com.hand.base.workbench.model.Campaign"
		parameterType="com.hand.base.workbench.model.Campaign">		
		<include refid="queryAllSql"/>
		<include refid="fromSql"/>
		where t.ROW_ID=#{id}
	</select>
  	
	<select id="brandQueryById" resultType="com.hand.base.workbench.model.Campaign"
		parameterType="com.hand.base.workbench.model.Campaign">		
		<include refid="queryAllSql"/>
		<include refid="fromSql"/>
		where t.ROW_ID=#{id}
	</select>

  	<insert id="insert" parameterType="com.hand.base.workbench.model.Campaign">
		insert into CX_O_CAMPAIGN
		  (ROW_ID, Name , CODE, STATUS , T_ATTR_01, T_ATTR_02 , T_ATTR_05
		  , T_ATTR_04 , TYPE, T_ATTR_06, source)
		values
		  (#{id},#{name},TB_O2O_ACCTIVITYCODE(),#{status},#{shareType},#{shareTheme},#{url}
		   ,#{shareNotes},#{type},#{cityId},'fast shopping')
	</insert>
  
	<update id="update" parameterType="com.hand.base.workbench.model.Campaign">
		update CX_O_CAMPAIGN t
		   set t.Name = #{name}, t.CODE = #{code}, t.STATUS = #{status},
		       t.T_ATTR_01 = #{shareType}, t.T_ATTR_02 = #{shareTheme}, t.T_ATTR_05 = #{url},
		       t.T_ATTR_04 = #{shareNotes}, t.TYPE = #{type}, t.source = 'fast shopping'
		 where t.row_id = #{id}
	</update>
	
  	<insert id="brandInsert" parameterType="com.hand.base.workbench.model.Campaign">
		insert into CX_O_CAMPAIGN
		  (ROW_ID, Name , CODE, STATUS , T_ATTR_01, T_ATTR_02 , T_ATTR_05
		  , T_ATTR_04 , TYPE, T_ATTR_06,T_ATTR_03,classify_id,source)
		values
		  (#{id},#{name},TB_O2O_ACCTIVITYCODE(),#{status},#{shareType},#{shareTheme},#{url}
		   ,#{shareNotes},#{type},#{cityId},#{charePicId},#{classifyId},'brand')
	</insert>
  
	<update id="brandUpdate" parameterType="com.hand.base.workbench.model.Campaign">
		update CX_O_CAMPAIGN t
		   set t.Name = #{name}, t.CODE = #{code}, t.STATUS = #{status},
		       t.T_ATTR_01 = #{shareType}, t.T_ATTR_02 = #{shareTheme}, t.T_ATTR_05 = #{url},
		       t.T_ATTR_04 = #{shareNotes}, t.TYPE = #{type},t.T_ATTR_03 = #{charePicId},
		       t.classify_id = #{classifyId}, t.source = 'brand'
		 where t.row_id = #{id}
	</update>
	
	<delete id="deleteById" parameterType="com.hand.base.workbench.model.Campaign">
		DELETE FROM CX_O_CAMPAIGN WHERE ROW_ID = #{id}
	</delete>
	
	<select id="queryByConsDrawPage" parameterType="com.hand.base.workbench.model.Campaign" resultMap="campaign">
	SELECT
	T.ROW_ID as id,
	date_format(T.CREATED,'%Y-%m-%d %H:%i:%S') as created,
	T.CREATED_BY as createdBy,
	date_format(T.LAST_UPD, '%Y-%m-%d %H:%i:%S') as lastUpdated,
	T.LAST_UPD_BY as lastUpdatedBy,
	round(t.AMT_PER_CONSUMER) amtPerConsumer,
	t.CODE code,
	t.DRAW_TYPE drawType,
	round(t.FACE_VALUE) faceValue,
	t.NAME name,
	t.RESTRICTION restriction,
	t.CITY_ID cityId, 
	t1.name city,
	t.END_TIME endTime,
	t.NOTES notes,
	t.START_TIME startTime,
	t2.row_id orgId
	from CX_O_PMO_SP t
	LEFT JOIN (CX_O_AREA t1  LEFT JOIN lnk_org_ext T2 ON T2.ROW_ID = T1.T_ATTR_05) on t1.row_id=t.CITY_ID
	where 1=1
	<if test="cityId != null and cityId !='' ">
		and city_id=#{cityId}
		and t.status='Active' 
	</if>
	<if test="type != null and type !='' ">
		and t.type=#{type}
	</if>
	<if test="source != null and source !='' ">
		and t.source=#{source}
	</if>
	<if test="type == 'Coupon' and source =='brand' ">
		and if(now() &gt; t.end_time,'Time out',t.brand_coupon_status) = 'Give out'
	</if>
	<if test="type == 'Second Kill' and source =='brand' ">
		and t.status='Active'
	</if>
	order by t.CREATED desc
  	</select>

    <update id="campImageUpdate" parameterType="com.hand.base.workbench.model.Campaign">
	 	UPDATE CX_O_CAMPAIGN t
		   SET t.T_ATTR_03 = #{charePicId}
		 WHERE t.row_id = #{id}
    </update>
    
	<update id="lineImageUpdate" parameterType="com.hand.base.workbench.model.Campaign">
	 	UPDATE CX_O_CAM_LINE t
		   SET t.PIC_ID = #{picId}
		 WHERE t.row_id = #{id}
    </update>
</mapper>