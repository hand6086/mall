<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hand.base.promotion.dao.mybatis.mapper.SalesPromotionSchemaMapper">
  <resultMap type="com.hand.base.promotion.model.SalesPromotionSchema" id="salesPromotionSchema"></resultMap>
	
	<!-- 暂时使用distinct去重 使得t2表满足条件的数据只显示一条  -->
	<sql id="querySchemaSql">
		SELECT
			distinct t1.ROW_ID id,/*促销方案编码*/
			t1.CREATED created,
			t1.CREATED_BY createdBy,
			date_format(t1.last_upd, '%Y-%m-%d %H:%i:%S') lastUpdated ,
			t1.LAST_UPD_BY lastUpdatedBy,
			t1.CORP_ID corpid,
			t5.fst_name createdName,
			t1.SCHEMA_NAME schemaName,/*促销方案名称*/
			date_format(t1.START_DATE, '%Y-%m-%d %H:%i:%S') startDate,/*开始时间*/
			date_format(t1.END_DATE, '%Y-%m-%d %H:%i:%S') endDate,/*结束时间*/
			t1.CITY city,/*大区*/
			t1.DEFAULT_PRODUCT defaultProduct,/*默认商品*/
			t1.STATUS status,/*方案状态*/
			t1.TYPE type,/*促销形式*/
			t1.APPROVAL_FLG approvalFlg,/*活动自动审批*/
			t1.COMMENTS comments, /*说明*/
			t4.row_id orgId
	</sql>
	
	<sql id="fromSchemaSql">
		FROM
			LNK_SALE_SCHEMA t1
				LEFT JOIN (
					LNK_INTER_CITY_SALE t2
					LEFT JOIN (
						CX_O_AREA t3
						LEFT JOIN lnk_org_ext t4 ON t4.ROW_ID = t3.T_ATTR_05
					) ON t3.row_id = t2.city_id
				) ON t2.sale_schema_id = t1.row_id
				LEFT JOIN lnk_emp_info t5 on t1.CREATED_BY = t5.row_id
	</sql>
	
	<sql id="whereSchemaSql">
		WHERE 1 = 1
		AND t1.delete_flg != 'Y'
		AND T1.SOURCE = 'fast shopping'
		<if test="usersystemRole != 'super_administrator' ">
			and t1.corp_id = #{usercorpid}
		<!-- 
			<if test="isApproved == '' or isApproved == null">
				and t2.city_id=#{orgId}
			</if>
		 -->
		</if>
		<if test="oauth == null or oauth == '' or oauth == 'ALL' ">
			group by t1.ROW_ID
		</if>
	</sql>

	<sql id="queryBrandSchemaSql">
		SELECT 
			 T1.ROW_ID            as id                  /*记录ID*/
			,T1.CREATED           as created             /*创建时间*/
			,T1.CREATED_BY        as createdBy           /*创建者ID*/
			,DATE_FORMAT(T1.LAST_UPD, '%Y-%m-%d %H:%k:%S') as lastUpdated         /*最后更新时间*/
			,T1.LAST_UPD_BY       as lastUpdatedBy       /*最后更新者ID*/
			,T1.SCHEMA_NAME       as schemaName          /*方案名称*/
			,date_format(T1.T_ATTR_13, '%Y-%m-%d %H:%i:%S') as tattr13            /*报名开始时间*/
			,date_format(T1.T_ATTR_14, '%Y-%m-%d %H:%i:%S') as tattr14            /*报名结束时间*/
			,t1.TYPE 			  as type				 /*促销形式*/
			,date_format(t1.START_DATE, '%Y-%m-%d %H:%i:%S') as startDate		  /*活动开始时间*/
			,date_format(t1.END_DATE, '%Y-%m-%d %H:%i:%S') as endDate			  /*活动结束时间*/
			/*参数brandStatus为空为活动报名需要字段（中文），不为空为英文 （页面搜索栏查询使用）*/
			<if test=" brandStatus == null or brandStatus == '' ">
				,IF (t1.brand_status = 'PAUSE','暂停中',
				CASE
					WHEN now() &lt; T1.T_ATTR_13 THEN
						'未开始'
					WHEN now() BETWEEN T1.T_ATTR_13 AND T1.T_ATTR_14 THEN
						'报名中'
					WHEN now() BETWEEN T1.T_ATTR_14	AND T1.START_DATE THEN
						'报名结束'
					WHEN now() BETWEEN t1.START_DATE AND t1.END_DATE THEN
						'进行中'
					ELSE
						'已结束'
					END ) brandStatus
			</if>
			
			<if test=" brandStatus != '' and brandStatus != null ">
				,IF (t1.brand_status = 'PAUSE','PAUSE',
				CASE
					WHEN now() &lt; T1.T_ATTR_13 THEN
						'NO_START'
					WHEN now() BETWEEN T1.T_ATTR_13 AND T1.T_ATTR_14 THEN
						'STARTING'
					WHEN now() BETWEEN T1.T_ATTR_14	AND T1.START_DATE THEN
						'END_ENROLL'
					WHEN now() BETWEEN t1.START_DATE AND t1.END_DATE THEN
						'GOING'
					ELSE
						'END'
					END ) brandStatus
			</if>	 /*品牌馆方案状态*/
			,t1.COMMENTS 		  as comments 			 /*说明*/
			,t1.PIC_ID			  as picId				 /*图片ID*/
			,T1.SOURCE            as source 			 /*频道类型*/
			,t2.PATH			  as path				 /*图片路径*/
	</sql>
	
	<sql id="fromBrandSchemaSql">
		FROM
			LNK_SALE_SCHEMA t1
			LEFT JOIN cx_o_img t2 on t1.PIC_ID = t2.row_id
		WHERE 1=1
	</sql>
	
	<sql id="whereBrandSchemaSql">
		AND T1.SOURCE = 'brand'
		AND t1.delete_flg != 'Y'
		<!-- 		
		<if test="usersystemRole != 'super_administrator' ">
			and t1.corp_id = #{usercorpid}
		</if> 
		-->
		<if test="type != null and type != '' ">
			AND t1.type = #{type}
		</if>
		<if test="id != null and id != '' ">
			AND t1.row_id = #{id}
		</if>
	</sql>
	
	<select id="queryByExamplePage" resultMap="salesPromotionSchema" parameterType="com.hand.base.promotion.model.SalesPromotionSchema">
		<include refid="querySchemaSql"/>
		<include refid="fromSchemaSql"/>
		<include refid="whereSchemaSql"/>
		order by t1.CREATED desc
	</select>
	<!-- 品牌馆方案查询 -->
	<select id="brandQueryByExamplePage" resultMap="salesPromotionSchema" parameterType="com.hand.base.promotion.model.SalesPromotionSchema">
		<include refid="queryBrandSchemaSql"/>
		<include refid="fromBrandSchemaSql"/>
		<include refid="whereBrandSchemaSql"/>
		order by t1.CREATED desc
	</select>
	
	<select id="brandQueryById" resultMap="salesPromotionSchema" parameterType="com.hand.base.promotion.model.SalesPromotionSchema">
		<include refid="queryBrandSchemaSql"/>
		<include refid="fromBrandSchemaSql"/>
		and t1.ROW_ID=#{id}
		group by t1.ROW_ID
	</select>
	
	<select id="queryById" resultMap="salesPromotionSchema" parameterType="com.hand.base.promotion.model.SalesPromotionSchema">
		<include refid="querySchemaSql"/>
		<include refid="fromSchemaSql"/>
		WHERE t1.ROW_ID=#{id}
		group by t1.ROW_ID
	</select>
	
  	<insert id="insert" parameterType="com.hand.base.promotion.model.SalesPromotionSchema">
  		INSERT INTO LNK_SALE_SCHEMA
		  (ROW_ID, SCHEMA_NAME, START_DATE, END_DATE, CITY, CITY_ID, DEFAULT_PRODUCT, STATUS, TYPE,APPROVAL_FLG , COMMENTS,SOURCE,delete_flg)
		VALUES
		  (#{id},#{schemaName},#{startDate},#{endDate}, #{city}, #{cityId}, #{defaultProduct},#{status},#{type},#{approvalFlg},#{comments},'fast shopping','N')
	</insert>
	
	<update id="update" parameterType="com.hand.base.promotion.model.SalesPromotionSchema">
  		UPDATE LNK_SALE_SCHEMA
  		SET 
  		   ROW_ID = #{id}
  		   <if test="schemaName != null and schemaName != '' ">
         	  ,SCHEMA_NAME=#{schemaName}
  		   </if>
  		   <if test="startDate != null and startDate != '' ">
         	  ,START_DATE=#{startDate}
  		   </if>
  		   <if test="endDate != null and endDate != '' ">
         	  ,END_DATE=#{endDate}
  		   </if>
  		   <if test="city != null and city != '' ">
         	  ,CITY=#{city}
  		   </if>
  		   <if test="cityId != null and cityId != '' ">
         	  ,CITY_ID=#{cityId}
  		   </if>
  		   <if test="defaultProduct != null and defaultProduct != '' ">
         	  ,DEFAULT_PRODUCT=#{defaultProduct}
  		   </if>
  		   <if test="status != null and status != '' ">
         	  ,STATUS=#{status}
  		   </if>
  		   <if test="type != null and type != '' ">
         	  ,TYPE=#{type}
  		   </if>
  		   <if test="approvalFlg != null and approvalFlg != '' ">
         	  ,APPROVAL_FLG=#{approvalFlg} 
  		   </if>
  		   <if test="comments != null and comments != '' ">
         	  ,COMMENTS=#{comments}
  		   </if>
  		   <if test="deleteFlg != null and deleteFlg != '' ">
         	  ,delete_flg  		   =#{deleteFlg}        
  		   </if>
		WHERE ROW_ID = #{id}
	</update>
	
  	<insert id="brandInsert" parameterType="com.hand.base.promotion.model.SalesPromotionSchema">
		INSERT INTO LNK_SALE_SCHEMA(
		 ROW_ID              /*记录ID*/
		,SCHEMA_NAME         /*方案名称*/
		,PIC_ID         	 /*方案图片*/
		,T_ATTR_13           /*报名开始时间*/
		,T_ATTR_14           /*报名结束时间*/
		,TYPE           	 /*促销形式*/
		,START_DATE          /*活动开始时间*/
		,END_DATE            /*活动结束时间*/
		,BRAND_STATUS        /*方案状态*/
		,COMMENTS            /*方案说明*/
		,SOURCE              /*频道类型*/
		,delete_flg			 /*删除标识*/
		) values (
		 #{id}               /*记录ID*/
		,#{schemaName}       /*方案名称*/
		,#{picId}         	 /*方案图片*/
		,#{tattr13}          /*报名开始时间*/
		,#{tattr14}          /*报名结束时间*/
		,#{type}        	 /*促销形式*/
		,#{startDate}        /*活动开始时间*/
		,#{endDate}          /*活动结束时间*/
		,#{brandStatus}      /*方案状态*/
		,#{comments}         /*方案说明*/
		,'brand'         	 /*频道类型*/
		,'N'				 /*删除标识*/
		)
	</insert>
	
	<update id="brandUpdate" parameterType="com.hand.base.promotion.model.SalesPromotionSchema">
		UPDATE LNK_SALE_SCHEMA 
		SET
			ROW_ID=#{id}
		   <if test="schemaName != null and schemaName != '' ">
         	  ,SCHEMA_NAME         =#{schemaName}       
  		   </if>
		   <if test="picId != null and picId != '' ">
         	  ,PIC_ID         	   =#{picId}         	
  		   </if>
		   <if test="tattr13 != null and tattr13 != '' ">
         	  ,T_ATTR_13           =#{tattr13}         
  		   </if>
		   <if test="tattr14 != null and tattr14 != '' ">
         	  ,T_ATTR_14           =#{tattr14}         
  		   </if>
		   <if test="type != null and type != '' ">
         	  ,TYPE           	   =#{type}        	    
  		   </if>
		   <if test="startDate != null and startDate != '' ">
         	  ,START_DATE          =#{startDate}        
  		   </if>
		   <if test="endDate != null and endDate != '' ">
         	  ,END_DATE            =#{endDate}          
  		   </if>
		   <if test="brandStatus != null and brandStatus != '' ">
         	  ,BRAND_STATUS        =#{brandStatus}      
  		   </if>
		   <if test="comments != null and comments != '' ">
         	  ,COMMENTS  		   =#{comments}         
  		   </if>
		   <if test="deleteFlg != null and deleteFlg != '' ">
         	  ,delete_flg  		   =#{deleteFlg}        
  		   </if>
		WHERE ROW_ID=#{id}
	</update>
	
	<delete id="deleteById" parameterType="com.hand.base.promotion.model.SalesPromotionSchema">
		DELETE FROM LNK_SALE_SCHEMA WHERE ROW_ID = #{id}
	</delete>
</mapper>