<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hand.base.rongcloud.dao.mybatis.mapper.RcsUserMapper">
	<resultMap type="com.hand.base.rongcloud.model.RcsUser" id="rcsUser"></resultMap>
	
	<sql id="queryTableSql">
		SELECT
			t1.row_id id,
			a.NAME name,
			t1.PHONE_NUMBER phonNum,
			t2.rong_token rongToken,
			a.path portrait
	</sql>
	
	<sql id="fromTableSql">
		FROM
			cx_o2o_user_v t1
		LEFT JOIN cx_o_user_token t2 on t1.row_id = t2.user_id
		LEFT JOIN (SELECT t3.row_id row_id,t4.thumb_path path,t3.name name from lnk_accnt t3 LEFT JOIN cx_o_img t4 on t3.attrib_52 = t4.row_id
		)a on t1.T_ATTR_01 = a.row_id
		where 1=1
	</sql>
	
	<sql id="whereTableSql">
		<if test=" phonNum != null and phonNum != ''">
			AND t1.PHONE_NUMBER = #{phonNum}
			AND t1.USER_TYPE = 'Customer'
		</if>
	</sql>
	<select id="queryByExamplePage" resultMap="rcsUser" parameterType="com.hand.base.rongcloud.model.RcsUser">
		<include refid="queryTableSql"/>
		<include refid="fromTableSql"/>
		<include refid="whereTableSql"/>
	</select>
	
	<select id="queryById" resultMap="rcsUser" parameterType="com.hand.base.rongcloud.model.RcsUser">
		<include refid="queryTableSql"/>
		<include refid="fromTableSql"/>
		AND t1.ROW_ID = #{id}
	</select>
  	
	<update id="updateRongToken" parameterType="com.hand.base.rongcloud.model.RcsUser">
		update cx_o_user_token t
		   set t.rong_token = #{rongToken},
		   	   t.last_upd = now()
		 where t.user_id = #{id}
	</update>
</mapper>